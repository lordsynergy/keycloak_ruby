# spec/keycloak_ruby/config_spec.rb
RSpec.describe KeycloakRuby::Config do
  let(:config) { described_class.new("lib/keycloak_ruby/spec/fixtures/keycloak.yml") }

  describe "#initialize" do
    it "loads realm from YAML" do
      expect(config.realm).to eq("test-realm")
    end

    it "loads keycloak_url from YAML" do
      expect(config.keycloak_url).to eq("https://keycloak.test")
    end

    it "builds token_url from config" do
      expect(config.token_url).to eq("https://keycloak.test/realms/test-realm/protocol/openid-connect/token")
    end

    it "builds redirect_url from app_host" do
      expect(config.redirect_url).to eq("http://localhost:3000/auth/keycloak/callback")
    end
  end

  describe "#validate!" do
    it "raises an error if required field is missing" do
      config.oauth_client_id = nil
      expect { config.validate! }.to raise_error(KeycloakRuby::Errors::ConfigurationError, /oauth_client_id/)
    end
  end

  describe "#required_attributes" do
    it "includes all derived values" do
      config.validate!
      expect(config.realm_url).to include("realms/test-realm")
    end
  end
end
